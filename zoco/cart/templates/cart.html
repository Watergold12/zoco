{% extends 'base.html' %}
{% load static %}
{% block content %}

<section class="cart section-container">
    <div>
        <!-- Premium Cart Header -->
        <div
            style="padding: 3rem 2.5rem; border-bottom: 1px solid var(--color-rose-50); display: flex; align-items: center; justify-content: space-between;">
            <div>
                <h2 class="font-heading" style="font-size: 2.25rem; font-weight: bold; color: var(--color-midnight);">
                    Your Wardrobe</h2>
                <p
                    style="font-size: 10px; letter-spacing: 0.3em; text-transform: uppercase; color: var(--color-rosegold); font-weight: bold; margin-top: 0.5rem;">
                    Personal Selection</p>
            </div>
        </div>

        <!-- Cart Items Container (Scrollable) -->
        <div id="cartItemsContainer" style="flex-grow: 1; overflow-y: auto; padding: 2rem 2.5rem;"
            class="custom-scrollbar">
            <!-- Empty State -->
            {% if not cart_items %}
                <div id="emptyCart"
                    style="height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; gap: 2rem;">
                    <div style="position: relative;">
                        <div
                            style="width: 8rem; height: 8rem; background-color: rgba(255, 241, 242, 0.5); border-radius: 9999px; display: flex; align-items: center; justify-content: center;">
                            <i class="fa-solid fa-bag-shopping"
                                style="font-size: 2.25rem; color: rgba(183, 110, 121, 0.3);"></i>
                        </div>
                    </div>
                    <div>
                        <h3 class="font-heading"
                            style="font-size: 1.5rem; font-weight: bold; margin-bottom: 0.75rem; color: var(--color-midnight);">
                            The bag is currently empty</h3>
                        <p
                            style="color: var(--color-gray-400); font-size: 0.875rem; max-width: 250px; margin: 0 auto; font-style: italic;">
                            "True elegance starts with the right essentials. Discover yours today."</p>
                    </div>
                    <a href="{% url 'collections' %}" class="btn-primary"
                        style="display: block; width: auto; padding: 1rem 2.5rem;">Explore Arrivals</a>
                </div>
            {% else %}
                <div id="cartList" style="display: flex; flex-direction: column; gap: 2rem;">
                    <!-- Items will appear here -->
                    {% for item in cart_items %}
                        <div class="cart-item">
                            <div class="cart-item-img-wrapper">
                                <img src="{{ item.product.image.url }}" class="cart-item-img">
                            </div>
                            <div class="cart-item-details">
                                <h4 class="cart-item-title">{{ item.product.name }}</h4>
                                <p class="cart-item-size" style="font-size: 0.75rem; color: var(--color-gray-500); margin-top: 0.5rem; margin-bottom: 0.5rem;">
                                    Size: <strong>{{ item.size }}</strong>
                                </p>
                                <p class="cart-item-price">₹{{ item.product.price }}</p>
                                
                                <div class="cart-qty-wrapper">
                                    <div class="cart-qty-input">
                                        <button class="cart-qty-btn qty-change" data-id="{{ item.key }}" data-action="minus">-</button>
                                        <span class="cart-qty-display" id="qty-{{ item.key }}">
                                            {{ item.quantity }}
                                        </span>
                                        <button class="cart-qty-btn qty-change" data-id="{{ item.key }}" data-action="plus">+</button>
                                    </div>
                                    <button type="button" data-index="{{ item.key }}" class="update-cart-btn">Update</button>
                                </div>
                            </div>
                            <button type="button" data-index="{{ item.key }}" class="cart-remove-btn">
                                <i class="fa-solid fa-trash-can"></i>
                            </button>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        </div>

        {% if cart_items %}
            <!-- Cart Footer -->
            <div id="cartFooter"
                style="padding: 2.5rem; background-color: rgba(255, 249, 248, 0.5); border-top: 1px solid var(--color-rose-100);">
                <div style="margin-bottom: 2rem; display: flex; flex-direction: column; gap: 1rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span
                            style="color: var(--color-gray-500); font-size: 0.75rem; font-weight: bold; letter-spacing: 0.1em; text-transform: uppercase;">Subtotal</span>
                        <span id="cartSubtotal" class="font-heading"
                            style="font-size: 1.25rem; font-weight: bold; color: var(--color-midnight);">₹{{ cart.get_total }}</span>
                    </div>
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; font-size: 10px; font-weight: bold; letter-spacing: 0.1em; text-transform: uppercase; color: var(--color-deepgreen);">
                        <span>Shipping</span>
                        <span
                            style="background-color: rgba(45, 90, 39, 0.1); padding: 0.25rem 0.5rem; border-radius: 0.25rem;">Complimentary</span>
                    </div>
                    <div
                        style="padding-top: 1rem; border-top: 1px solid var(--color-rose-100); display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: var(--color-midnight); font-weight: bold;">Total</span>
                        <span id="cartTotal" class="font-heading"
                            style="font-size: 1.5rem; font-weight: bold; color: var(--color-rosegold);">₹{{ cart.get_total }}</span>
                    </div>
                </div>
                <a href="{% url 'checkout' %}" class="btn-primary">Checkout Securely</a>
            </div>
        {% endif %}
    </div>
</section>

<script>
    // Handle Quantity +/- buttons in the cart page
    $(document).on('click', '.qty-change', function(e) {
        e.preventDefault();
        const productId = $(this).data('id');
        const action = $(this).data('action');
        const qtySpan = $('#qty-' + productId);
        let currentQty = parseInt(qtySpan.text().trim());

        if (action === 'plus') {
            currentQty++;
        } else if (action === 'minus' && currentQty > 1) {
            currentQty--;
        }
        
        qtySpan.text(currentQty);
    });

    // Handle Update Cart button
    $(document).on('click', '.update-cart-btn', function(e){
        e.preventDefault();
        const productId = $(this).data('index');
        const productQty = $('#qty-' + productId).text().trim();
        
        $.ajax({
            type: 'POST',
            url: '{% url "cart_update" %}',
            data: {
                product_id: productId,
                product_qty: productQty,
                csrfmiddlewaretoken: '{{ csrf_token }}',
                action: 'post'
            },
            success: function(json){
                location.reload();
            },
            error: function(xhr, errmsg, err){
                console.error(errmsg);
            }
        }); 
    });

    // Handle Delete Item Cart button
    $(document).on('click', '.cart-remove-btn', function(e){
        e.preventDefault();
        const productId = $(this).data('index');
        
        $.ajax({
            type: 'POST',
            url: '{% url "cart_delete" %}',
            data: {
                product_id: productId,
                csrfmiddlewaretoken: '{{ csrf_token }}',
                action: 'post'
            },
            success: function(json){
                location.reload();
            },
            error: function(xhr, errmsg, err){
                console.error(errmsg);
            }
        }); 
    });
</script>
{% endblock %}